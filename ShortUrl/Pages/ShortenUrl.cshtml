@page
@model ShortenUrlModel
@{
    ViewData["Title"] = "Shorten URL";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-page="/Index">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Shorten URL</li>
                </ol>
            </nav>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">Shorten a URL</h2>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="Shorten" enctype="multipart/form-data">
                        <div asp-validation-summary="All" class="text-danger mb-3"></div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customSlug" class="form-label">Custom Slug (optional):</label>
                                <input type="text" class="form-control" id="customSlug" name="CustomSlug" placeholder="e.g., my-custom-slug" />
                                <small class="form-text text-muted">Use alphanumeric characters, hyphens, or underscores.</small>
                            </div>
                        </div>
                        <div id="destination-urls">
                            <div class="form-group destination-url mb-3">
                                <label class="form-label">Destination URL 1:</label>
                                <input type="url" class="form-control" name="DestinationUrls[0].Url" required placeholder="https://example.com" />
                                @if (User.IsInRole("Professional") || User.IsInRole("Enterprise"))
                                {
                                    <div class="row mt-2">
                                        <div class="col-md-4 mb-2">
                                            <input type="text" class="form-control" name="DestinationUrls[0].UtmSource" placeholder="UTM Source" />
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <input type="text" class="form-control" name="DestinationUrls[0].UtmMedium" placeholder="UTM Medium" />
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <input type="text" class="form-control" name="DestinationUrls[0].UtmCampaign" placeholder="UTM Campaign" />
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        @if (User.IsInRole("Professional") || User.IsInRole("Enterprise"))
                        {
                            <button type="button" onclick="addDestinationUrl()" class="btn btn-outline-secondary mb-4">
                                <i class="fas fa-plus-circle"></i> Add Another Destination URL
                            </button>

                            <hr class="my-4">
                            <h5>Social Media Preview Settings</h5>
                            <div id="og-variations" class="mb-3">
                                <div class="card mb-3 og-variation">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-2 text-muted">Social Media Metadata 1</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">Title:</label>
                                                <input type="text" class="form-control" name="OgMetadataVariations[0].Title" placeholder="Title" />
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">Image:</label>
                                                <input type="file" class="form-control" name="OgMetadataVariations[0].ImageFile" accept="image/*" />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Description:</label>
                                                <textarea class="form-control" name="OgMetadataVariations[0].Description" placeholder="Description" rows="2"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="addOgVariation()" class="btn btn-outline-secondary mb-4">
                                <i class="fas fa-plus-circle"></i> Add Another Metadata Variation
                            </button>
                        }

                        @if (User.IsInRole("Enterprise"))
                        {
                            <hr class="my-4">
                            <h5>Advanced Options</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="expirationDate" class="form-label">Expiration Date (optional):</label>
                                    <input type="datetime-local" class="form-control" id="expirationDate" name="ExpirationDate" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">Password (optional):</label>
                                    <input type="password" class="form-control" id="password" name="Password"
                                           autocomplete="new-password"
                                           readonly onfocus="this.removeAttribute('readonly');" />
                                </div>
                            </div>
                        }

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-link"></i> Shorten URL
                            </button>
                            <a asp-page="/Index" class="btn btn-outline-secondary ms-2">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.ShortenedUrl))
            {
                <div class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center w-100">
                        <div class="me-2">
                            <span class="fw-bold">Shortened URL:</span>
                            <a href="@Model.ShortenedUrl" target="_blank" class="ms-2">@Model.ShortenedUrl</a>
                        </div>
                        @if (User.IsInRole("Enterprise"))
                        {
                            <a href="/qr/@Model.ShortenedUrl.Split('/').Last()" class="btn btn-sm btn-secondary mt-2 mt-md-0">
                                <i class="fas fa-qr-code"></i> Download QR Code
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let urlCount = 1;
        let ogCount = 1;

        function addDestinationUrl() {
            urlCount++;
            const container = document.getElementById('destination-urls');
            const div = document.createElement('div');
            div.className = 'form-group destination-url mb-3';

            let html = `
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <label class="form-label mb-0">Destination URL ${urlCount}:</label>
                    <button type="button" onclick="removeDestinationUrl(this)" class="btn btn-sm btn-outline-danger">Remove</button>
                </div>
                <input type="url" class="form-control" name="DestinationUrls[${urlCount - 1}].Url" required placeholder="https://example.com" />`;

            // Append professional fields if needed
            @if (User.IsInRole("Professional") || User.IsInRole("Enterprise"))
            {
                <text>
                html += `
                <div class="row mt-2">
                    <div class="col-md-4 mb-2">
                        <input type="text" class="form-control" name="DestinationUrls[${urlCount - 1}].UtmSource" placeholder="UTM Source" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <input type="text" class="form-control" name="DestinationUrls[${urlCount - 1}].UtmMedium" placeholder="UTM Medium" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <input type="text" class="form-control" name="DestinationUrls[${urlCount - 1}].UtmCampaign" placeholder="UTM Campaign" />
                    </div>
                </div>`;
                </text>
            }

            div.innerHTML = html;
            container.appendChild(div);
        }

        function addOgVariation() {
            ogCount++;
            const container = document.getElementById('og-variations');
            const div = document.createElement('div');
            div.className = 'card mb-3 og-variation';
            div.innerHTML = `
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h6 class="card-subtitle mb-0 text-muted">Social Media Metadata ${ogCount}</h6>
                        <button type="button" onclick="removeOgVariation(this)" class="btn btn-sm btn-outline-danger">Remove</button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Title:</label>
                            <input type="text" class="form-control" name="OgMetadataVariations[${ogCount - 1}].Title" placeholder="Title" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Image:</label>
                            <input type="file" class="form-control" name="OgMetadataVariations[${ogCount - 1}].ImageFile" accept="image/*" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description:</label>
                            <textarea class="form-control" name="OgMetadataVariations[${ogCount - 1}].Description" placeholder="Description" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function removeDestinationUrl(button) {
            button.closest('.destination-url').remove();
        }

        function removeOgVariation(button) {
            button.closest('.og-variation').remove();
        }
    </script>
}